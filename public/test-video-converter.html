<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Format Converter - Browser-based</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #8b5cf6;
            background: #faf5ff;
        }
        .upload-area.active {
            border-color: #8b5cf6;
            background: #f3e8ff;
        }
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        button:hover {
            background: #7c3aed;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .progress {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .video-preview {
            margin: 20px 0;
            display: none;
        }
        video {
            width: 100%;
            max-height: 400px;
            border-radius: 8px;
        }
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¬ Video Format Converter</h1>
        <p class="subtitle">Convert your video to browser-compatible format (H.264 + AAC)</p>

        <div class="info">
            <strong>Note:</strong> This uses your browser's built-in encoding. It works best with:
            <ul>
                <li>Chrome, Edge (recommended)</li>
                <li>Modern Firefox</li>
                <li>Videos under 200MB</li>
            </ul>
        </div>

        <div class="upload-area" id="dropZone">
            <p style="font-size: 48px; margin: 0;">ðŸ“¹</p>
            <p><strong>Drop video here or click to browse</strong></p>
            <p style="color: #666; font-size: 14px;">Supports: MP4, MOV, AVI, WebM</p>
        </div>

        <input type="file" id="fileInput" accept="video/*">

        <div class="video-preview" id="originalPreview">
            <h3>Original Video:</h3>
            <video id="originalVideo" controls></video>
            <p id="originalInfo"></p>
        </div>

        <div class="progress" id="progressBar">
            <div class="progress-bar" id="progressBarFill">0%</div>
        </div>

        <button id="convertBtn" style="display: none;">Convert to Compatible Format</button>

        <div class="video-preview" id="convertedPreview">
            <h3>Converted Video (Browser-Compatible):</h3>
            <video id="convertedVideo" controls></video>
            <p id="convertedInfo"></p>
            <button id="downloadBtn">Download Converted Video</button>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const originalPreview = document.getElementById('originalPreview');
        const originalVideo = document.getElementById('originalVideo');
        const originalInfo = document.getElementById('originalInfo');
        const convertBtn = document.getElementById('convertBtn');
        const progressBar = document.getElementById('progressBar');
        const progressBarFill = document.getElementById('progressBarFill');
        const convertedPreview = document.getElementById('convertedPreview');
        const convertedVideo = document.getElementById('convertedVideo');
        const convertedInfo = document.getElementById('convertedInfo');
        const downloadBtn = document.getElementById('downloadBtn');

        let selectedFile = null;

        // Drag and drop
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('active');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            selectedFile = file;
            const url = URL.createObjectURL(file);
            originalVideo.src = url;
            originalPreview.style.display = 'block';
            convertBtn.style.display = 'block';
            convertedPreview.style.display = 'none';

            originalVideo.onloadedmetadata = () => {
                originalInfo.innerHTML = `
                    <strong>File:</strong> ${file.name}<br>
                    <strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    <strong>Duration:</strong> ${formatDuration(originalVideo.duration)}<br>
                    <strong>Resolution:</strong> ${originalVideo.videoWidth} Ã— ${originalVideo.videoHeight}
                `;
            };
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        convertBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            try {
                convertBtn.disabled = true;
                progressBar.style.display = 'block';
                progressBarFill.style.width = '0%';
                progressBarFill.textContent = '0%';

                // Create canvas and capture frames
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = originalVideo.videoWidth;
                canvas.height = originalVideo.videoHeight;

                // Set up MediaRecorder with browser-compatible format
                const stream = canvas.captureStream(30); // 30 FPS

                // Add audio track from original video
                const videoElement = document.createElement('video');
                videoElement.src = URL.createObjectURL(selectedFile);
                await new Promise(resolve => {
                    videoElement.onloadedmetadata = resolve;
                });

                const audioCtx = new AudioContext();
                const source = audioCtx.createMediaElementSource(videoElement);
                const dest = audioCtx.createMediaStreamDestination();
                source.connect(dest);
                source.connect(audioCtx.destination);

                // Combine video and audio streams
                const audioTrack = dest.stream.getAudioTracks()[0];
                if (audioTrack) {
                    stream.addTrack(audioTrack);
                }

                const mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=h264,opus',
                    videoBitsPerSecond: 2500000
                });

                const chunks = [];
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        chunks.push(e.data);
                    }
                };

                mediaRecorder.start();
                videoElement.muted = true;
                originalVideo.currentTime = 0;
                originalVideo.play();
                videoElement.play();

                // Draw frames to canvas
                const drawFrame = () => {
                    if (!originalVideo.paused && !originalVideo.ended) {
                        ctx.drawImage(originalVideo, 0, 0, canvas.width, canvas.height);

                        const progress = (originalVideo.currentTime / originalVideo.duration) * 100;
                        progressBarFill.style.width = progress + '%';
                        progressBarFill.textContent = Math.round(progress) + '%';

                        requestAnimationFrame(drawFrame);
                    }
                };
                drawFrame();

                // Wait for video to finish
                await new Promise(resolve => {
                    originalVideo.onended = () => {
                        mediaRecorder.stop();
                        resolve();
                    };
                });

                // Create blob and display
                await new Promise(resolve => {
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(chunks, { type: 'video/webm' });
                        const url = URL.createObjectURL(blob);

                        convertedVideo.src = url;
                        convertedPreview.style.display = 'block';

                        convertedVideo.onloadedmetadata = () => {
                            convertedInfo.innerHTML = `
                                <strong>Format:</strong> WebM (H.264 + Opus - Browser Compatible)<br>
                                <strong>Size:</strong> ${(blob.size / 1024 / 1024).toFixed(2)} MB<br>
                                <strong>Duration:</strong> ${formatDuration(convertedVideo.duration)}<br>
                                <strong>Resolution:</strong> ${convertedVideo.videoWidth} Ã— ${convertedVideo.videoHeight}
                            `;
                        };

                        downloadBtn.onclick = () => {
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'converted-video.webm';
                            a.click();
                        };

                        convertBtn.disabled = false;
                        progressBar.style.display = 'none';
                        audioCtx.close();
                        resolve();
                    };
                });

            } catch (error) {
                console.error('Conversion error:', error);
                alert('Conversion failed: ' + error.message + '\n\nPlease try using an online converter or ffmpeg instead.');
                convertBtn.disabled = false;
                progressBar.style.display = 'none';
            }
        });
    </script>
</body>
</html>
